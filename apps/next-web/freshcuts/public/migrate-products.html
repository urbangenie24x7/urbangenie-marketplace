<!DOCTYPE html>
<html>
<head>
    <title>Migrate Products Collection</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Products Collection Migration</h1>
    <button onclick="migrateProducts()">Start Products Migration</button>
    <div id="result"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAR757jp5A9sKg45vqZckfwTCLSLC-PRGk",
            authDomain: "freshcuts-5cb4c.firebaseapp.com",
            projectId: "freshcuts-5cb4c",
            storageBucket: "freshcuts-5cb4c.firebasestorage.app",
            messagingSenderId: "14592809171",
            appId: "1:14592809171:web:b618aa729d65385f3d1c26"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Helper function to generate variation ID
        function generateVariationId() {
            return 'var_' + Math.random().toString(36).substr(2, 9);
        }

        // Helper function to standardize variations
        function standardizeVariations(oldVariations) {
            if (!oldVariations || !Array.isArray(oldVariations)) {
                return [];
            }

            return oldVariations.map((variation, index) => {
                // Create display name from variation properties
                let displayName = '';
                if (variation.weight) displayName += `${variation.weight} `;
                if (variation.quantity) displayName += `${variation.quantity} pieces `;
                if (variation.size) displayName += `${variation.size} `;
                if (variation.cut) displayName += `${variation.cut} `;
                if (variation.prep) displayName += `(${variation.prep})`;
                
                displayName = displayName.trim() || `Variation ${index + 1}`;

                return {
                    id: generateVariationId(),
                    name: displayName,
                    weight: typeof variation.weight === 'string' ? 
                           parseInt(variation.weight.replace(/[^0-9]/g, '')) || 500 : 
                           variation.weight || 500,
                    unit: variation.unit || 'g',
                    cut: variation.cut || 'regular',
                    preparation: variation.prep || 'cleaned',
                    priceMultiplier: variation.priceMultiplier || 1.0,
                    available: true,
                    minOrderQty: 1,
                    maxOrderQty: 10
                };
            });
        }

        // Helper function to generate tags from product name and category
        function generateTags(name, category) {
            const tags = [category];
            const nameLower = name.toLowerCase();
            
            // Add common tags based on product name
            if (nameLower.includes('boneless')) tags.push('boneless');
            if (nameLower.includes('fresh')) tags.push('fresh');
            if (nameLower.includes('premium')) tags.push('premium');
            if (nameLower.includes('organic')) tags.push('organic');
            if (nameLower.includes('halal')) tags.push('halal');
            
            return [...new Set(tags)]; // Remove duplicates
        }

        async function migrateProducts() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Starting products migration...</p>';

            try {
                const productsSnap = await db.collection('products').get();
                let productsUpdated = 0;
                let errors = [];

                for (const doc of productsSnap.docs) {
                    try {
                        const data = doc.data();
                        const now = new Date();

                        // Prepare updates object
                        const updates = {
                            // Add missing fields with defaults
                            description: data.description || `Fresh ${data.name || 'product'} - premium quality`,
                            baseUnit: data.unit || 'kg',
                            minimumOrderQuantity: data.minimumOrderQuantity || 0.5,
                            images: data.images || [],
                            featured: data.featured || false,
                            tags: data.tags || generateTags(data.name || '', data.category || ''),
                            searchKeywords: data.searchKeywords || (data.name || '').toLowerCase(),
                            
                            // Nutritional info (placeholder)
                            nutritionalInfo: data.nutritionalInfo || {
                                protein: 'See packaging',
                                calories: 'See packaging',
                                fat: 'See packaging'
                            },
                            
                            // Storage and shelf life
                            storageInstructions: data.storageInstructions || 'Keep refrigerated at 0-4°C',
                            shelfLife: data.shelfLife || '2-3 days refrigerated',
                            
                            // Standardize variations
                            variations: standardizeVariations(data.variations),
                            
                            // Metadata
                            updatedAt: now,
                            createdAt: data.createdAt || now,
                            createdBy: data.createdBy || 'system',
                            version: (data.version || 0) + 1
                        };

                        // Rename unit to baseUnit if it exists
                        if (data.unit && !data.baseUnit) {
                            updates.baseUnit = data.unit;
                            updates.unit = firebase.firestore.FieldValue.delete();
                        }

                        await doc.ref.update(updates);
                        productsUpdated++;

                        resultDiv.innerHTML += `<p style="color: green;">✅ Updated: ${data.name}</p>`;
                    } catch (error) {
                        errors.push(`Error updating ${doc.id}: ${error.message}`);
                        resultDiv.innerHTML += `<p style="color: red;">❌ Error: ${doc.id} - ${error.message}</p>`;
                    }
                }

                resultDiv.innerHTML += `
                    <div style="color: green; margin-top: 20px;">
                        <h3>✅ Products migration completed!</h3>
                        <p>• Updated ${productsUpdated} products</p>
                        <p>• Errors: ${errors.length}</p>
                        ${errors.length > 0 ? '<h4>Errors:</h4><ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>' : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML += `
                    <div style="color: red;">
                        <h3>❌ Migration failed:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>