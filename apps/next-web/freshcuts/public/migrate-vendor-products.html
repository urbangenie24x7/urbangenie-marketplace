<!DOCTYPE html>
<html>
<head>
    <title>Migrate VendorProducts Collection</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>VendorProducts Collection Migration</h1>
    <button onclick="migrateVendorProducts()">Start VendorProducts Migration</button>
    <div id="result"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAR757jp5A9sKg45vqZckfwTCLSLC-PRGk",
            authDomain: "freshcuts-5cb4c.firebaseapp.com",
            projectId: "freshcuts-5cb4c",
            storageBucket: "freshcuts-5cb4c.firebasestorage.app",
            messagingSenderId: "14592809171",
            appId: "1:14592809171:web:b618aa729d65385f3d1c26"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function migrateVendorProducts() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Starting vendor products migration...</p>';

            try {
                const vendorProductsSnap = await db.collection('vendorProducts').get();
                let vendorProductsUpdated = 0;
                let errors = [];

                for (const doc of vendorProductsSnap.docs) {
                    try {
                        const data = doc.data();
                        const now = new Date();

                        // Prepare updates object
                        const updates = {
                            // Add missing fields with defaults
                            stockQuantity: data.stockQuantity || 50,
                            lastUpdated: now,
                            createdAt: data.createdAt || now,
                            
                            // Ensure delivery options have proper structure
                            deliveryOptions: data.deliveryOptions || {
                                pickup: { available: true, charges: 0 },
                                normal: { available: true, charges: 0, time: '3-4 hours', minOrderForFree: 500 },
                                express: { available: false, charges: 50, time: '1 hour', minOrderForFree: 1000 }
                            }
                        };

                        // Remove vendorVariations field (use master product variations instead)
                        if (data.vendorVariations) {
                            updates.vendorVariations = firebase.firestore.FieldValue.delete();
                        }

                        await doc.ref.update(updates);
                        vendorProductsUpdated++;

                        resultDiv.innerHTML += `<p style="color: green;">✅ Updated vendor product: ${doc.id}</p>`;
                    } catch (error) {
                        errors.push(`Error updating ${doc.id}: ${error.message}`);
                        resultDiv.innerHTML += `<p style="color: red;">❌ Error: ${doc.id} - ${error.message}</p>`;
                    }
                }

                resultDiv.innerHTML += `
                    <div style="color: green; margin-top: 20px;">
                        <h3>✅ VendorProducts migration completed!</h3>
                        <p>• Updated ${vendorProductsUpdated} vendor products</p>
                        <p>• Removed vendorVariations fields</p>
                        <p>• Added stockQuantity and timestamps</p>
                        <p>• Errors: ${errors.length}</p>
                        ${errors.length > 0 ? '<h4>Errors:</h4><ul>' + errors.map(e => `<li>${e}</li>`).join('') + '</ul>' : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML += `
                    <div style="color: red;">
                        <h3>❌ Migration failed:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>