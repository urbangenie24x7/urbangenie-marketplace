<!DOCTYPE html>
<html>
<head>
    <title>Migrate Vendors</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>Vendor Migration</h1>
    <button onclick="migrateVendors()">Start Migration</button>
    <div id="result"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAR757jp5A9sKg45vqZckfwTCLSLC-PRGk",
            authDomain: "freshcuts-5cb4c.firebaseapp.com",
            projectId: "freshcuts-5cb4c",
            storageBucket: "freshcuts-5cb4c.firebasestorage.app",
            messagingSenderId: "14592809171",
            appId: "1:14592809171:web:b618aa729d65385f3d1c26"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        async function migrateVendors() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>Starting migration...</p>';

            try {
                // Step 1: Add role field to all vendors
                const vendorsSnap = await db.collection('vendors').get();
                let vendorUpdates = 0;
                
                for (const doc of vendorsSnap.docs) {
                    await doc.ref.update({ role: 'vendor' });
                    vendorUpdates++;
                }

                // Step 2: Move vendor users from users to vendors
                const vendorUsersSnap = await db.collection('users').where('role', '==', 'vendor').get();
                let usersMoved = 0;
                let usersDeleted = 0;

                for (const userDoc of vendorUsersSnap.docs) {
                    const userData = userDoc.data();
                    
                    // Check if vendor already exists in vendors collection
                    const existingVendor = await db.collection('vendors').where('phone', '==', userData.phone).get();
                    
                    if (existingVendor.empty) {
                        // Create new vendor record
                        await db.collection('vendors').add({
                            ...userData,
                            role: 'vendor',
                            name: userData.name || userData.shopName,
                            businessName: userData.shopName || userData.name
                        });
                        usersMoved++;
                    }
                    
                    // Delete from users collection
                    await userDoc.ref.delete();
                    usersDeleted++;
                }

                resultDiv.innerHTML = `
                    <div style="color: green;">
                        <h3>✅ Migration completed successfully!</h3>
                        <p>• Updated ${vendorUpdates} vendors with role field</p>
                        <p>• Moved ${usersMoved} vendor users to vendors collection</p>
                        <p>• Deleted ${usersDeleted} vendor users from users collection</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="color: red;">
                        <h3>❌ Migration failed:</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>